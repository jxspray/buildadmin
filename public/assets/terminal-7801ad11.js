import{x as I,y as x,n as U,I as v}from"./vue-9a46e809.js";import{b as P,i as W}from"./index-ae07247d.js";import{t as N}from"./index-01bed986.js";import{d as O}from"./common-535f3731.js";import{u as A}from"./random-1d7fa280.js";var a=(t=>(t[t.Waiting=0]="Waiting",t[t.Connecting=1]="Connecting",t[t.Executing=2]="Executing",t[t.Success=3]="Success",t[t.Failed=4]="Failed",t[t.Unknown=5]="Unknown",t))(a||{});const _=I("terminal",()=>{const t=x({show:!1,showDot:!1,taskList:[],packageManager:"pnpm",showPackageManagerDialog:!1,showConfig:!1,automaticCleanupTask:"1",port:"8000"});function m(){for(const s in t.taskList)(t.taskList[s].status==a.Connecting||t.taskList[s].status==a.Executing)&&(t.taskList[s].status=a.Unknown)}function r(s=!t.show){t.show=s,s&&u(!1)}function u(s=!t.showDot){t.showDot=s}function w(s=!t.showConfig){r(!s),t.showConfig=s}function p(s=!t.showPackageManagerDialog){r(!s),t.showPackageManagerDialog=s}function h(s){t.packageManager=s}function T(s){t.port=s}function C(s){t.automaticCleanupTask=s}function o(s,e){t.taskList[s].status=e,(e==a.Failed||e==a.Unknown)&&t.taskList[s].blockOnFailure&&k(s,!0)}function l(s){if(typeof t.taskList[s].callback!="function")return;const e=t.taskList[s].status;e==a.Failed||e==a.Unknown?t.taskList[s].callback(a.Failed):e==a.Success&&t.taskList[s].callback(a.Success)}function k(s,e=!t.taskList[s].showMessage){t.taskList[s].showMessage=e}function f(s,e){t.show||u(!0),t.taskList[s].message=t.taskList[s].message.concat(e),U(()=>{D(t.taskList[s].uuid)})}function g(s,e=!0,n="",i=()=>{}){if(t.show||u(!0),t.taskList=t.taskList.concat({uuid:A(),createtime:N(),status:a.Waiting,command:s,message:[],showMessage:!1,blockOnFailure:e,extend:n,callback:i}),parseInt(t.automaticCleanupTask)===1&&d(),t.show===!1){for(const L in t.taskList)if(t.taskList[L].status==a.Failed||t.taskList[L].status==a.Unknown){v({type:"error",message:W.global.t("terminal.Newly added tasks will never start because they are blocked by failed tasks")});break}}c()}function M(s,e=!0,n="",i=()=>{}){g(s+"."+t.packageManager,e,n,i)}function b(s){t.taskList[s].status!=a.Connecting&&t.taskList[s].status!=a.Executing&&t.taskList.splice(s,1),c()}function c(){let s=null;for(const e in t.taskList){if(t.taskList[e].status==a.Waiting){s=parseInt(e);break}if(t.taskList[e].status==a.Connecting||t.taskList[e].status==a.Executing)break;if(t.taskList[e].status!=a.Success&&(t.taskList[e].status==a.Failed||t.taskList[e].status==a.Unknown)){if(t.taskList[e].blockOnFailure)break;continue}}s!==null&&(o(s,a.Connecting),F(s))}function F(s){window.eventSource=new EventSource(O(t.taskList[s].command,t.taskList[s].uuid,t.taskList[s].extend)),window.eventSource.onmessage=function(e){const n=JSON.parse(e.data);if(!n||!n.data)return;const i=E(n.uuid);i!==!1&&(n.data=="command-exec-error"?(o(i,a.Failed),window.eventSource.close(),l(i),c()):n.data=="command-exec-completed"?(window.eventSource.close(),t.taskList[i].status!=a.Success&&o(i,a.Failed),l(i),c()):n.data=="command-link-success"?o(i,a.Executing):n.data=="command-exec-success"?o(i,a.Success):f(i,n.data))},window.eventSource.onerror=function(){window.eventSource.close();const e=S(s);e!==!1&&(o(e,a.Failed),l(e))}}function y(s){t.taskList[s].message=[],o(s,a.Waiting),c()}function d(){t.taskList=t.taskList.filter(s=>s.status!=a.Success)}function E(s){for(const e in t.taskList)if(t.taskList[e].uuid==s)return parseInt(e);return!1}function S(s){if(t.taskList[s])return s;{let e=-1;for(const n in t.taskList)(t.taskList[n].status==a.Connecting||t.taskList[n].status==a.Executing)&&(e=parseInt(n));return e===-1?!1:e}}function D(s){const e=document.querySelector(".exec-message-"+s);e&&e.scrollHeight&&(e.scrollTop=e.scrollHeight)}return{state:t,init:m,toggle:r,toggleDot:u,setTaskStatus:o,setTaskShowMessage:k,addTaskMessage:f,addTask:g,addTaskPM:M,delTask:b,startTask:c,retryTask:y,clearSuccessTask:d,togglePackageManagerDialog:p,toggleConfigDialog:w,changePackageManager:h,changePort:T,changeAutomaticCleanupTask:C}},{persist:{key:P,paths:["state.showDot","state.taskList","state.automaticCleanupTask"]}});export{a as t,_ as u};
